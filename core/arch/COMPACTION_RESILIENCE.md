# Compaction Resilience

> **Audience:** All agents  
> **Load:** On-demand (Tier 3), referenced from MEMORY_LIFECYCLE.md  
> **Problem:** Compaction is lossy. Information that exists only in conversation history can be permanently lost.

## Principle: Persist Before You Forget

Every piece of actionable information (IDs, decisions, URLs, credentials, task state) must be written to persistent storage within the same conversational turn it appears. Never defer memory writes.

Conversation is volatile storage. Treat it that way.

---

## Three Layers of Defense

### Layer 1: Write-Through (preventive) — PRIMARY

Write actionable information to files in the **same turn** it appears. This is the most important defense. If done consistently, compaction can lose anything and nothing breaks.

| Information type | Write to | When |
|-----------------|----------|------|
| New service/channel/endpoint ID | MEMORY.md or `memory/ref-*.md` | Same turn |
| Principal-confirmed decision | MEMORY.md Pending/Active section | Same turn |
| Credential/token | SECRETS.md | Same turn |
| Lesson learned | `memory/ref-lessons.md` | Same turn |
| New file/tool created | Corresponding index file (see ASSET_REGISTRATION) | Same turn |

**The test:** after every turn where new information appeared, ask: *"If compaction happened right now, would I lose anything?"* If yes — write it first.

### Layer 2: SESSION.md (buffer) — SECONDARY

Maintain a `SESSION.md` file in the agent's directory (`$JOYA_MY/agents/<name>/SESSION.md`). This is a WAL (Write-Ahead Log) for conversation state — it captures in-progress work that doesn't yet belong in MEMORY.md.

```markdown
# SESSION.md — volatile working state
# Auto-cleared on task completion. Read on session start.

## Current Task
What I'm actively working on, current progress, next step.

## Pending Questions
Questions asked to Principal that haven't been answered yet.

## Uncommitted Context
Information fragments from this session not yet in MEMORY.md.
(Channel IDs discovered, half-formed decisions, design directions under discussion.)
```

**Update frequency:** At each significant step (not every message).  
**Cleanup:** Clear completed sections. On task completion, archive relevant parts to MEMORY.md or daily memory, then clear SESSION.md.  
**On session start:** Always read SESSION.md to recover working context.

### Layer 3: Post-Compaction Self-Check (detective) — TERTIARY

After compaction (detected by: summary block at conversation start), automatically:

1. Read SESSION.md — compare with summary, identify gaps
2. Check MEMORY.md Pending items for completeness
3. If discrepancies found → **proactively report to Principal**: "I may have lost context about X. Can you confirm?"

Do not silently guess. Do not pretend you remember. Flag the gap.

---

## What Goes Where

| Content | MEMORY.md | SESSION.md | Daily memory |
|---------|-----------|------------|-------------|
| Stable facts (IDs, endpoints) | ✅ | — | — |
| Current task state | — | ✅ | — |
| Pending decisions | ✅ (brief) | ✅ (detailed) | — |
| Session narrative | — | — | ✅ |
| Lessons learned | ref-lessons.md | — | — |
| Unanswered questions | — | ✅ | — |

## Why Existing Mechanisms Are Insufficient

- **MEMORY.md** — Designed as lean index; not for in-progress work state
- **Daily memory** (`memory/YYYY-MM-DD.md`) — Typically written at session end; compaction happens mid-session
- **Compaction summary** — Generated by runtime, not agent-controlled; summaries are inherently lossy
- **SESSION.md fills the gap** — Agent-maintained, real-time, persistent working state

## Anti-patterns

- ❌ "I'll update MEMORY.md later" — Later may never come
- ❌ Treating conversation history as reliable storage
- ❌ Assuming compaction summary will capture everything
- ❌ Silently proceeding after compaction without checking for lost context
- ✅ Write immediately, buffer in SESSION.md, verify after compaction

---

*This protocol emerged from repeated compaction-induced context loss (2026-02-21). The cost of writing too eagerly is a few extra file edits; the cost of writing too late is permanent information loss and broken trust.*
